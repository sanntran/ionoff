<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
	xmlns:context="http://www.springframework.org/schema/context"
	xmlns:tx="http://www.springframework.org/schema/tx" 
	xmlns:mvc="http://www.springframework.org/schema/mvc"
	xmlns:security="http://www.springframework.org/schema/security"
	xmlns:task="http://www.springframework.org/schema/task"
	xsi:schemaLocation="
		http://www.springframework.org/schema/beans
		http://www.springframework.org/schema/beans/spring-beans-4.0.xsd
		http://www.springframework.org/schema/context
		http://www.springframework.org/schema/context/spring-context-4.0.xsd
		http://www.springframework.org/schema/tx
		http://www.springframework.org/schema/tx/spring-tx-4.0.xsd
		http://www.springframework.org/schema/mvc
		http://www.springframework.org/schema/mvc/spring-mvc-4.0.xsd
		http://www.springframework.org/schema/security 
		http://www.springframework.org/schema/security/spring-security-4.2.xsd
		http://www.springframework.org/schema/task
		http://www.springframework.org/schema/task/spring-task-4.2.xsd" >

	<!-- Database Configuration -->
	<import resource="data-source.xml" />
	<import resource="data-access.xml" />

	<mvc:annotation-driven />
	
	<task:annotation-driven scheduler="taskScheduler"/>
    <task:scheduler id="taskScheduler" pool-size="8"/>


	<context:component-scan base-package="net.ionoff.center.server.controller, net.ionoff.center.server.scheduler" />

	<bean id="taskExecutor" class="org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor">
	  <property name="corePoolSize" value="5" />
	  <property name="maxPoolSize" value="10" />
	  <property name="queueCapacity" value="25" />
	</bean>

	<bean id="jwtTokenUtil" class="net.ionoff.center.server.security.JwtTokenUtil">
	</bean>

	<bean id="passwordEncoder"
		class="org.springframework.security.crypto.password.StandardPasswordEncoder">
		<constructor-arg value="FVUhwvR3zS" />
	</bean>

	<security:authentication-manager id="authenticationManager">
		<security:authentication-provider
			user-service-ref="userService">
			<security:password-encoder ref="passwordEncoder" />
		</security:authentication-provider>
	</security:authentication-manager>

	<security:http pattern="/api/errors/**" security="none" />
	<security:http pattern="/api/users/license" security="none" />
	<security:http pattern="/api/users/authenticate" security="none" />
	<security:http pattern="/api/system/*" security="none" />

	<security:http entry-point-ref="unauthorizedEntryPoint"
		authentication-manager-ref="authenticationManager" create-session="stateless">
		<security:csrf disabled="true" />
		
		<security:custom-filter ref="authenticationTokenFilter" position="PRE_AUTH_FILTER" />
		
		<security:intercept-url pattern="/api/projects" access="hasRole('ROLE_SYSTEM_ADMIN')" />
		<security:intercept-url pattern="/api/projects/*" access="hasRole('ROLE_SYSTEM_ADMIN')" />
		
		<security:intercept-url method="PUT" pattern="/api/**" access="hasRole('ROLE_PROJECT_ADMIN')" />
		<security:intercept-url method="DELETE" pattern="/api/**" access="hasRole('ROLE_PROJECT_ADMIN')" />

		<security:intercept-url method="PUT" pattern="/api/playlists" access="hasRole('ROLE_PROJECT_USER')" />
		<security:intercept-url method="PUT" pattern="/api/playlists/*" access="hasRole('ROLE_PROJECT_USER')" />
		<security:intercept-url method="DELETE" pattern="/api/playlists/*" access="hasRole('ROLE_PROJECT_USER')" />
		<security:intercept-url method="DELETE" pattern="/api/playleafs/*" access="hasRole('ROLE_PROJECT_USER')" />
		<security:intercept-url method="DELETE" pattern="/api/playnodes/*" access="hasRole('ROLE_PROJECT_USER')" />

		<security:intercept-url method="POST" pattern="/api/modes/*/activate" access="hasRole('ROLE_PROJECT_ADMIN')" />

		<security:intercept-url method="POST" pattern="/api/**/close" access="hasRole('ROLE_PROJECT_USER')" />
		<security:intercept-url method="POST" pattern="/api/**/open" access="hasRole('ROLE_PROJECT_USER')" />
		<security:intercept-url method="POST" pattern="/api/**/closeopen" access="hasRole('ROLE_PROJECT_USER')" />
		<security:intercept-url method="POST" pattern="/api/**/activate" access="hasRole('ROLE_PROJECT_USER')" />
		<security:intercept-url method="POST" pattern="/api/**/trigger" access="hasRole('ROLE_PROJECT_USER')" />
		<security:intercept-url method="POST" pattern="/api/**/on" access="hasRole('ROLE_PROJECT_USER')" />
		<security:intercept-url method="POST" pattern="/api/**/off" access="hasRole('ROLE_PROJECT_USER')" />
		<security:intercept-url method="POST" pattern="/api/**/command" access="hasRole('ROLE_PROJECT_USER')" />

	</security:http>

	<bean id="unauthorizedEntryPoint"
		class="net.ionoff.center.server.security.UnauthorizedEntryPoint" />

	<bean id="authenticationTokenFilter"
		class="net.ionoff.center.server.security.JwtAuthenticationTokenFilter">
	</bean>

	<context:component-scan base-package="net.ionoff.center.server.controller" />

	<bean id="controlService" class="net.ionoff.center.server.control.ControlServiceImpl">
	</bean>

	<bean id="sensorStatusNotifier" class="net.ionoff.center.server.message.SensorStatusNotifier">
	</bean>

	<bean id="sensorStatusChangedListener"
		class="net.ionoff.center.server.message.listener.SensorStatusChangedListener">
	</bean>
	
	<bean id="sensorStatusChangedHandler"
		class="net.ionoff.center.server.message.handler.SensorStatusChangedHandler">
	</bean>
	
	<bean id="relayStatusNotifier" class="net.ionoff.center.server.message.RelayStatusNotifier">
	</bean>
	
	<bean id="relayStatusChangedListener" 
				class="net.ionoff.center.server.message.listener.RelayStatusChangedListener">
	</bean>

	<bean id="relayStatusChangedHandler"
				class="net.ionoff.center.server.message.handler.RelayStatusChangedHandler">
	</bean>

	<bean id="mediaServiceConnector" class="net.ionoff.center.server.mediadata.connector.MediaDataConnectorImpl">
	</bean>

	<bean id="mediaPlayerConnector" class="net.ionoff.center.server.mediaplayer.connector.MediaPlayerConnectorImpl">
	</bean>

	<bean id="playerCaches" class="net.ionoff.center.server.mediaplayer.cache.PlayerCaches">
	</bean>

	<bean id="mediaPlayerService"
		class="net.ionoff.center.server.mediaplayer.service.MediaPlayerServiceImpl">
		<constructor-arg ref="mediaPlayerConnector" />
		<constructor-arg ref="playerCaches" />
		<constructor-arg ref="mediaServiceConnector" />
	</bean>

	<bean id="dataService" class="net.ionoff.center.server.mediadata.service.MediaDataServiceImpl">
		<constructor-arg ref="mediaServiceConnector" />
		<constructor-arg ref="mediaPlayerService" />
	</bean>

	<bean id="latestVersionUpdator" class="net.ionoff.center.server.scheduler.LatestVersionUpdator">
	</bean>

	<bean id="areaMapper" class="net.ionoff.center.server.persistence.mapper.AreaMapper">
	</bean>

	<bean id="relayDriverMapper" class="net.ionoff.center.server.persistence.mapper.RelayDriverMapper">
	</bean>

	<bean id="deviceMapper" class="net.ionoff.center.server.persistence.mapper.DeviceMapper">
	</bean>

	<bean id="modeMapper" class="net.ionoff.center.server.persistence.mapper.ModeMapper">
	</bean>

	<bean id="playlistMapper" class="net.ionoff.center.server.persistence.mapper.PlayListMapper">
	</bean>
	
	<bean id="scheduleMapper" class="net.ionoff.center.server.persistence.mapper.ScheduleMapper">
	</bean>

	<bean id="projectMapper" class="net.ionoff.center.server.persistence.mapper.ProjectMapper">
	</bean>

	<bean id="relayMapper" class="net.ionoff.center.server.persistence.mapper.RelayMapper">
	</bean>

	<bean id="sceneMapper" class="net.ionoff.center.server.persistence.mapper.SceneMapper">
	</bean>

	<bean id="sensorMapper" class="net.ionoff.center.server.persistence.mapper.SensorMapper">
	</bean>

	<bean id="userMapper" class="net.ionoff.center.server.persistence.mapper.UserMapper">
	</bean>

	<bean id="zoneMapper" class="net.ionoff.center.server.persistence.mapper.ZoneMapper">
	</bean>
	
	<bean id="dashboardMapper" class="net.ionoff.center.server.persistence.mapper.DashboardMapper">
	</bean>

	<bean id="brokerClientFactory" class="net.ionoff.center.server.broker.BrokerClientFactory">
	</bean>

	<bean id="mqttConnection" class="net.ionoff.center.server.broker.MqttConnection">
	</bean>
	
	<bean id="relayDriverHandler" class="net.ionoff.center.server.relaydriver.RelayDriverHandler">
	</bean>

	<bean id="sensorDriverHandler" class="net.ionoff.center.server.sensordriver.SensorDriverHandler">
	</bean>

	<bean id="mediaPlayerHandler" class="net.ionoff.center.server.mediaplayer.MediaPlayerHandler">
	</bean>

	<bean id="relayDriverConnector" class="net.ionoff.center.server.relaydriver.connector.RelayDriverConnector">
	</bean>

	<bean id="lazyRelayDriverThread" class="net.ionoff.center.server.relaydriver.LazyRelayDriverThread">
	</bean>

	<bean id="notificationConnector" class="net.ionoff.center.server.notify.connector.NotificationConnectorImpl">
	</bean>

	<bean id="notificationService" class="net.ionoff.center.server.notify.NotificationServiceImpl">
	</bean>

</beans>
